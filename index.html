<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBEDTECH TRACKER DEVICE</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        /* --- General Resets & Variables (Light Theme) --- */
        :root {
            --bg-color-dark: #f8f8f8; /* Very light background for page */
            --bg-color-medium: #ffffff; /* White background for containers */
            --bg-color-light: #f0f0f0; /* Slightly off-white for list items */
            --text-color-primary: #333333; /* Dark text */
            --text-color-secondary: #666666; /* Slightly lighter dark text */
            --accent-color-blue: #007bff; /* Standard blue */
            --accent-color-red: #dc3545; /* Standard red */
            --border-color: #e0e0e0; /* Light border */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Light shadow */
            --transition-speed: 0.2s ease-in-out;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: auto; /* Allow body scrolling */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Global Elements --- */
        button {
            background-color: var(--accent-color-blue);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform 0.1s;
        }

        button:hover {
            background-color: #0056b3; /* Darker blue on hover */
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.outline {
            background-color: transparent;
            border: 1px solid var(--accent-color-blue);
            color: var(--accent-color-blue);
        }
        button.outline:hover {
            background-color: rgba(0, 123, 255, 0.1); /* Light blue tint on hover */
            color: var(--accent-color-blue);
        }

        button.danger {
            background-color: var(--accent-color-red);
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.danger.outline {
            background-color: transparent;
            border: 1px solid var(--accent-color-red);
            color: var(--accent-color-red);
        }
        button.danger.outline:hover {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--accent-color-red);
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-color-medium);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 26px;
            color: var(--accent-color-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        header h1 svg {
            width: 30px;
            height: 30px;
            fill: var(--accent-color-blue);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 15px;
            color: var(--text-color-secondary);
        }

        /* --- Main Content Area (for device list) --- */
        main {
            flex: 1; /* Occupy remaining vertical space */
            padding: 20px;
            display: flex;
            justify-content: center; /* Center the device container horizontally */
            align-items: flex-start; /* Align content to the top */
        }

        .device-container {
            width: 100%;
            max-width: 800px; /* Max width for readability */
            background-color: var(--bg-color-medium);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            position: relative; /* For loading overlay */
        }

        .device-container h2 {
            margin-top: 0;
            color: var(--text-color-primary);
            font-size: 22px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .device-list li {
            background-color: var(--bg-color-light);
            margin-bottom: 15px;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
            position: relative;
            overflow: hidden;
        }

        .device-list li:hover {
            background-color: #e5e5e5; /* Slightly darker on hover */
            border-color: var(--accent-color-blue);
        }

        .device-list li.active {
            background-color: #e0f2ff; /* Light blue tint for active */
            border-color: var(--accent-color-blue);
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px); /* Subtle lift */
        }

        .device-name {
            font-weight: 600;
            color: var(--text-color-primary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .last-update {
            font-size: 13px;
            color: var(--text-color-secondary);
            margin-bottom: 15px;
            display: block;
        }

        .device-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .device-controls button {
            padding: 8px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        .device-status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .device-status-badge.enabled {
            background-color: #28a745; /* Green */
        }
        .device-status-badge.paused {
            background-color: #ffc107; /* Orange/Yellow */
            color: #333;
        }

        /* --- Loading Overlay for Device List --- */
        #deviceListLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Light overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            border-radius: 12px; /* Match container */
            color: var(--accent-color-blue);
            font-size: 18px;
            font-weight: 500;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); /* Lighter spinner track */
            border-top: 4px solid var(--accent-color-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Footer --- */
        footer {
            background-color: var(--bg-color-medium);
            color: var(--text-color-secondary);
            padding: 15px 30px;
            text-align: center;
            font-size: 13px;
            box-shadow: 0 -2px 4px var(--shadow-color);
            z-index: 10;
        }

        /* --- Login Page Styles --- */
        #login-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-color-dark);
        }

        .login-box {
            background-color: var(--bg-color-medium);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: var(--accent-color-blue);
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
            color: var(--text-color-primary);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color-light);
            color: var(--text-color-primary);
            font-size: 16px;
            transition: border-color var(--transition-speed);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color-blue);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .login-error {
            color: var(--accent-color-red);
            margin-top: -10px;
            margin-bottom: 15px;
            font-size: 14px;
            min-height: 20px; /* Reserve space */
        }
        
        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 900px) {
            main {
                padding: 10px;
            }
            .device-container {
                max-width: 100%;
                margin: 0;
            }
        }
        @media (max-width: 480px) {
            header h1 {
                font-size: 18px;
            }
            header h1 svg {
                width: 25px;
                height: 25px;
            }
            .device-container h2 {
                font-size: 20px;
            }
            .device-list li {
                padding: 15px;
            }
            .device-name {
                font-size: 15px;
            }
            .last-update {
                font-size: 12px;
            }
            button {
                padding: 8px 12px;
                font-size: 13px;
            }
            .login-box {
                margin: 20px;
                padding: 30px 20px;
            }
            .login-box h2 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page">
        <div class="login-box">
            <h2>Login to OBEDTECH TRACKER</h2>
            <div class="form-group">
                <label for="emailInput">Email Address</label>
                <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="email" required>
            </div>
            <div id="loginError" class="login-error"></div>
            <button id="loginButton">Login</button>
            <p style="margin-top: 20px; font-size: 13px; color: var(--text-color-secondary);">
                Hint: Use <strong>alice@example.com</strong> or <strong>bob@example.com</strong> to test.
            </p>
        </div>
    </div>

    <!-- Dashboard Content (initially hidden) -->
    <header class="hidden">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            OBEDTECH TRACKER DEVICE
        </h1>
        <div class="user-info">
            <span id="loggedInUserEmail"></span>
            <button id="logoutButton" class="outline">Logout</button>
        </div>
    </header>

    <main class="hidden">
        <div class="device-container">
            <h2>My Devices</h2>
            <div id="deviceListLoading" class="loading-overlay hidden">
                <div class="spinner"></div>
                <p>Loading devices...</p>
            </div>
            <ul id="deviceList" class="device-list">
                <!-- Device items will be populated here by JavaScript -->
            </ul>
            <div id="noDevicesMessage" style="text-align: center; color: var(--text-color-secondary); padding: 20px;" class="hidden">
                No devices registered for this email.
            </div>
        </div>
    </main>

    <footer class="hidden">
        <p>&copy; 2023 OBEDTECH. All rights reserved. <a href="#" style="color: var(--accent-color-blue); text-decoration: none;">Privacy Policy</a></p>
    </footer>

    <!-- Your Custom JavaScript Logic -->
    <script>
        // --- Mock Data (Simulates your backend data) ---
        // In a real application, this data would come from your backend API
        let MOCK_USERS = [
            { id: 'user1', email: 'alice@example.com', name: 'Alice' },
            { id: 'user2', email: 'bob@example.com', name: 'Bob' },
        ];

        let MOCK_DEVICES = [
            { id: 'device1', userId: 'user1', label: 'Alice\'s Phone (Android)', platform: 'Android', lastUpdated: new Date(Date.now() - 5 * 60 * 1000), sharingEnabled: true, lastLocation: { lat: 34.0522, lng: -118.2437 } }, // LA
            { id: 'device2', userId: 'user1', label: 'Alice\'s Tablet', platform: 'iOS', lastUpdated: new Date(Date.now() - 30 * 60 * 1000), sharingEnabled: false, lastLocation: { lat: 37.7749, lng: -122.4194 } }, // SF
            { id: 'device3', userId: 'user1', label: 'Alice\'s Car Tracker', platform: 'IoT', lastUpdated: new Date(Date.now() - 2 * 60 * 60 * 1000), sharingEnabled: true, lastLocation: { lat: 33.7490, lng: -84.3880 } }, // Atlanta
            { id: 'device4', userId: 'user2', label: 'Bob\'s Work Phone', platform: 'Android', lastUpdated: new Date(Date.now() - 10 * 60 * 1000), sharingEnabled: true, lastLocation: { lat: 40.7128, lng: -74.0060 } }, // NYC
            { id: 'device5', userId: 'user2', label: 'Bob\'s Drone', platform: 'IoT', lastUpdated: new Date(Date.now() - 45 * 60 * 1000), sharingEnabled: false, lastLocation: { lat: 51.5074, lng: -0.1278 } }, // London
        ];

        // Since the map is removed, detailed location history is less relevant for display.
        // We can keep `lastLocation` directly in MOCK_DEVICES for "last known position".
        // The MOCK_LOCATION_SAMPLES structure can be simplified or removed if not needed.
        // For this version, I'll remove MOCK_LOCATION_SAMPLES as it implies history plotting.

        // --- Global Variables ---
        let activeDeviceId = null;
        let currentUser = null; // Will be set after successful login

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const emailInput = document.getElementById('emailInput');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');

        const header = document.querySelector('header');
        const main = document.querySelector('main');
        const footer = document.querySelector('footer');

        const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
        const logoutButton = document.getElementById('logoutButton');
        const deviceListUl = document.getElementById('deviceList');
        const noDevicesMessage = document.getElementById('noDevicesMessage');
        const deviceListLoading = document.getElementById('deviceListLoading');

        // --- Helper Functions ---

        function showLoading(element) { element.classList.remove('hidden'); }
        function hideLoading(element) { element.classList.add('hidden'); }

        function formatRelativeTime(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) return 'Never';
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `${seconds} secs ago`;
            if (minutes < 60) return `${minutes} mins ago`;
            if (hours < 24) return `${hours} hours ago`;
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString();
        }

        // --- UI View Management ---
        function showLogin() {
            loginPage.classList.remove('hidden');
            header.classList.add('hidden');
            main.classList.add('hidden');
            footer.classList.add('hidden');
            activeDeviceId = null;
            deviceListUl.innerHTML = '';
            hideLoading(deviceListLoading);
            noDevicesMessage.classList.add('hidden');
        }

        function showDashboard() {
            loginPage.classList.add('hidden');
            header.classList.remove('hidden');
            main.classList.remove('hidden');
            footer.classList.remove('hidden');
        }

        // --- API Simulation Functions ---
        async function fetchDevices(userId) {
            showLoading(deviceListLoading);
            noDevicesMessage.classList.add('hidden');
            console.log(`[MOCK API] Fetching devices for user: ${userId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    hideLoading(deviceListLoading);
                    const userDevices = MOCK_DEVICES.filter(d => d.userId === userId);
                    resolve(userDevices);
                }, 800); // Simulate network delay
            });
        }

        async function toggleDeviceSharing(deviceId, enable) {
            console.log(`[MOCK API] Toggling sharing for device ${deviceId} to ${enable}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    const device = MOCK_DEVICES.find(d => d.id === deviceId);
                    if (device) {
                        device.sharingEnabled = enable;
                        device.lastUpdated = new Date(); // Simulate update
                        resolve({ success: true, newStatus: enable });
                    } else {
                        resolve({ success: false, message: 'Device not found' });
                    }
                }, 500);
            });
        }

        async function revokeDevice(deviceId) {
            console.log(`[MOCK API] Revoking device: ${deviceId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    MOCK_DEVICES = MOCK_DEVICES.filter(d => d.id !== deviceId);
                    // No location samples to remove since map is gone
                    resolve({ success: true });
                }, 700);
            });
        }

        // --- Dashboard Rendering & Logic ---

        function renderDeviceList(devices) {
            deviceListUl.innerHTML = ''; // Clear existing list
            if (!devices || devices.length === 0) {
                noDevicesMessage.classList.remove('hidden');
                return;
            }
            noDevicesMessage.classList.add('hidden');

            devices.forEach(device => {
                const li = document.createElement('li');
                li.dataset.deviceId = device.id;
                if (device.id === activeDeviceId) {
                    li.classList.add('active');
                }

                const sharingStatusClass = device.sharingEnabled ? 'enabled' : 'paused';
                const sharingStatusText = device.sharingEnabled ? 'Enabled' : 'Paused';

                li.innerHTML = `
                    <div class="device-status-badge ${sharingStatusClass}">${sharingStatusText}</div>
                    <div class="device-name">${device.label}</div>
                    <div class="last-update">Last update: ${formatRelativeTime(new Date(device.lastUpdated))}</div>
                    <div class="last-location">Last known location: ${device.lastLocation ? `${device.lastLocation.lat.toFixed(4)}, ${device.lastLocation.lng.toFixed(4)}` : 'N/A'}</div>
                    <div class="device-controls">
                        <button class="toggle-sharing-btn ${device.sharingEnabled ? 'outline' : ''}" data-device-id="${device.id}" data-current-status="${device.sharingEnabled}">
                            ${device.sharingEnabled ? 'Pause Sharing' : 'Enable Sharing'}
                        </button>
                        <button class="revoke-device-btn danger outline" data-device-id="${device.id}">Revoke Device</button>
                    </div>
                `;
                deviceListUl.appendChild(li);
            });
        }

        // With no map, selecting a device just updates its active state and could theoretically show more details
        async function selectDevice(deviceId) {
            activeDeviceId = deviceId;

            document.querySelectorAll('.device-list li').forEach(item => {
                if (item.dataset.deviceId === deviceId) {
                    item.classList.add('active');
                    // You could add logic here to display more detailed device info if needed
                } else {
                    item.classList.remove('active');
                }
            });
            console.log(`Device selected: ${deviceId}. No map to plot.`);
            // No map plotting logic needed here
        }

        // --- Event Handlers ---

        async function handleLogin() {
            const email = emailInput.value.trim().toLowerCase();
            if (!email) {
                loginError.textContent = 'Please enter an email address.';
                return;
            }

            const user = MOCK_USERS.find(u => u.email === email);
            if (user) {
                currentUser = user;
                localStorage.setItem('loggedInUserId', user.id); // Simulate session
                localStorage.setItem('loggedInUserEmail', user.email); // Store email for display
                loginError.textContent = ''; // Clear any previous error
                
                showDashboard();
                setupDashboard();
            } else {
                loginError.textContent = 'Email not recognized. Please try alice@example.com or bob@example.com';
            }
        }

        async function handleDeviceListClick(event) {
            const listItem = event.target.closest('li[data-device-id]');
            if (!listItem) return;

            const deviceId = listItem.dataset.deviceId;

            if (event.target.classList.contains('toggle-sharing-btn')) {
                const currentStatus = event.target.dataset.currentStatus === 'true';
                const result = await toggleDeviceSharing(deviceId, !currentStatus);
                if (result.success) {
                    // Re-render device list to reflect new status
                    const updatedDevices = await fetchDevices(currentUser.id);
                    renderDeviceList(updatedDevices);
                } else {
                    alert(`Failed to update sharing: ${result.message}`);
                }
            } else if (event.target.classList.contains('revoke-device-btn')) {
                if (confirm(`Are you sure you want to revoke access for "${listItem.querySelector('.device-name').textContent}"? This cannot be undone.`)) {
                    const result = await revokeDevice(deviceId);
                    if (result.success) {
                        alert('Device revoked successfully.');
                        // Re-fetch and re-render devices
                        const updatedDevices = await fetchDevices(currentUser.id);
                        renderDeviceList(updatedDevices);
                        if (activeDeviceId === deviceId) {
                            activeDeviceId = null; // Clear active device if it was revoked
                        }
                    } else {
                        alert('Failed to revoke device.');
                    }
                }
            } else { // Clicked on the li itself (not a button)
                await selectDevice(deviceId);
            }
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUserId');
            localStorage.removeItem('loggedInUserEmail');
            currentUser = null;
            showLogin();
            deviceListUl.innerHTML = ''; // Clear device list
            noDevicesMessage.classList.add('hidden'); // Hide no devices message
            activeDeviceId = null; // Clear active device
            emailInput.value = ''; // Clear email input
            loginError.textContent = ''; // Clear login error
        }

        // --- Initial Dashboard Setup for a logged-in user ---
        async function setupDashboard() {
            if (!currentUser) {
                console.error("No current user set for dashboard setup.");
                showLogin();
                return;
            }

            loggedInUserEmailSpan.textContent = currentUser.email;
            logoutButton.addEventListener('click', handleLogout);
            deviceListUl.addEventListener('click', handleDeviceListClick);

            const devices = await fetchDevices(currentUser.id);
            renderDeviceList(devices);

            // Automatically select the first device if available
            if (devices.length > 0) {
                await selectDevice(devices[0].id);
            }
        }

        // --- Entry Point (After DOM is fully loaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Event listeners for login form
            loginButton.addEventListener('click', handleLogin);
            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Check for existing session
            const storedUserId = localStorage.getItem('loggedInUserId');
            const storedUserEmail = localStorage.getItem('loggedInUserEmail');

            if (storedUserId && storedUserEmail) {
                currentUser = MOCK_USERS.find(u => u.id === storedUserId && u.email === storedUserEmail);
                if (currentUser) {
                    showDashboard();
                    setupDashboard();
                    return; // Stop here, dashboard is being set up
                }
            }
            // If no valid session, show login page
            showLogin();
        });
    </script>
</body>
</html>
