<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker Dashboard - Dark Mode</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2366b3ff'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        /* --- General Resets & Variables --- */
        :root {
            --bg-color-dark: #1a1a2e;
            --bg-color-medium: #1f283d;
            --bg-color-light: #2c3e50;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #a0a0a0;
            --accent-color-blue: #66b3ff;
            --accent-color-red: #ff6b6b;
            --border-color: #3a475a;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --transition-speed: 0.2s ease-in-out;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll, main handles it */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Global Elements --- */
        button {
            background-color: var(--accent-color-blue);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform 0.1s;
        }

        button:hover {
            background-color: #559ee5; /* A slightly darker blue */
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.outline {
            background-color: transparent;
            border: 1px solid var(--accent-color-blue);
            color: var(--accent-color-blue);
        }
        button.outline:hover {
            background-color: rgba(102, 179, 255, 0.1);
            color: var(--accent-color-blue);
        }

        button.danger {
            background-color: var(--accent-color-red);
        }
        button.danger:hover {
            background-color: #e55a5a;
        }
        button.danger.outline {
            background-color: transparent;
            border: 1px solid var(--accent-color-red);
            color: var(--accent-color-red);
        }
        button.danger.outline:hover {
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--accent-color-red);
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-color-light);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px var(--shadow-color);
            z-index: 10; /* Above map */
        }

        header h1 {
            margin: 0;
            font-size: 26px;
            color: var(--accent-color-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        header h1 svg {
            width: 30px;
            height: 30px;
            fill: var(--accent-color-blue);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-size: 15px;
            color: var(--text-color-secondary);
        }

        /* --- Main Layout --- */
        main {
            display: flex;
            flex: 1; /* Occupy remaining vertical space */
            overflow: hidden; /* Sidebar and map will handle their own scrolling */
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            background-color: var(--bg-color-medium);
            padding: 25px 20px;
            box-shadow: 4px 0 10px var(--shadow-color);
            overflow-y: auto; /* Allow scrolling for device list */
            border-right: 1px solid var(--border-color);
            flex-shrink: 0; /* Don't allow it to shrink */
        }

        .sidebar h2 {
            margin-top: 0;
            color: var(--text-color-primary);
            font-size: 22px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .device-list li {
            background-color: var(--bg-color-light);
            margin-bottom: 15px;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
            position: relative;
            overflow: hidden;
        }

        .device-list li:hover {
            background-color: #374a60; /* Slightly lighter on hover */
            border-color: var(--accent-color-blue);
        }

        .device-list li.active {
            background-color: #3a475a; /* Slightly different active background */
            border-color: var(--accent-color-blue);
            box-shadow: 0 0 12px rgba(102, 179, 255, 0.3);
            transform: translateY(-2px); /* Subtle lift */
        }

        .device-name {
            font-weight: 600;
            color: var(--text-color-primary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .last-update {
            font-size: 13px;
            color: var(--text-color-secondary);
            margin-bottom: 15px;
            display: block;
        }

        .device-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .device-controls button {
            padding: 8px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        .device-status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .device-status-badge.enabled {
            background-color: #28a745; /* Green */
        }
        .device-status-badge.paused {
            background-color: #ffc107; /* Orange/Yellow */
            color: #333;
        }

        /* --- Map Container --- */
        .map-container {
            flex: 1; /* Occupy remaining horizontal space */
            background-color: var(--bg-color-dark);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #map {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #2a3a4c; /* Placeholder until map loads */
        }

        /* --- Loading Overlay --- */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 26, 46, 0.7); /* Semi-transparent dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20; /* Above map and content */
            color: var(--accent-color-blue);
            font-size: 18px;
            font-weight: 500;
            flex-direction: column;
            gap: 15px;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent-color-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Footer --- */
        footer {
            background-color: var(--bg-color-light);
            color: var(--text-color-secondary);
            padding: 15px 30px;
            text-align: center;
            font-size: 13px;
            box-shadow: 0 -4px 8px var(--shadow-color);
            z-index: 10;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 40vh; /* Limit height on small screens */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                box-shadow: 0 4px 10px var(--shadow-color);
                overflow-y: scroll; /* Ensure scrollability */
            }
            header {
                padding: 10px 20px;
            }
            header h1 {
                font-size: 22px;
            }
            .user-info span {
                display: none; /* Hide email on very small screens */
            }
            .device-controls button {
                flex: 1 1 auto; /* Fill available space */
            }
        }
        @media (max-width: 480px) {
            header h1 {
                font-size: 18px;
            }
            header h1 svg {
                width: 25px;
                height: 25px;
            }
            .sidebar h2 {
                font-size: 20px;
            }
            .device-list li {
                padding: 15px;
            }
            .device-name {
                font-size: 15px;
            }
            .last-update {
                font-size: 12px;
            }
            button {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
    
    <!-- Google Maps API -->
    <!-- You MUST replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>
</head>
<body>
    <header>
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            Location Dashboard
        </h1>
        <div class="user-info">
            <span id="loggedInUserEmail"></span>
            <button id="logoutButton" class="outline">Logout</button>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <h2>My Devices</h2>
            <div id="sidebarLoading" class="loading-overlay" style="position: static; background: none; min-height: 100px; display: none;">
                <div class="spinner"></div>
                <p>Loading devices...</p>
            </div>
            <ul id="deviceList" class="device-list">
                <!-- Device items will be populated here by JavaScript -->
            </ul>
        </aside>

        <section class="map-container">
            <div id="map"></div>
            <div id="mapLoading" class="loading-overlay">
                <div class="spinner"></div>
                <p>Loading map and location data...</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 Location Tracker. All rights reserved. <a href="#" style="color: var(--accent-color-blue); text-decoration: none;">Privacy Policy</a></p>
    </footer>

    <!-- Your Custom JavaScript Logic -->
    <script>
        // --- Mock Data (Simulates your backend data) ---
        let MOCK_USERS = [
            { id: 'user1', email: 'alice@example.com', name: 'Alice' },
            { id: 'user2', email: 'bob@example.com', name: 'Bob' },
        ];

        let MOCK_DEVICES = [
            { id: 'device1', userId: 'user1', label: 'Alice\'s Phone (Android)', platform: 'Android', lastUpdated: new Date(Date.now() - 5 * 60 * 1000), sharingEnabled: true },
            { id: 'device2', userId: 'user1', label: 'Alice\'s Tablet', platform: 'iOS', lastUpdated: new Date(Date.now() - 30 * 60 * 1000), sharingEnabled: false },
            { id: 'device3', userId: 'user1', label: 'Alice\'s Car Tracker', platform: 'IoT', lastUpdated: new Date(Date.now() - 2 * 60 * 60 * 1000), sharingEnabled: true },
        ];

        let MOCK_LOCATION_SAMPLES = {
            'device1': [
                { lat: 34.0522, lng: -118.2437, recordedAt: new Date(Date.now() - 5 * 60 * 1000) }, // LA
                { lat: 34.0535, lng: -118.2520, recordedAt: new Date(Date.now() - 10 * 60 * 1000) },
                { lat: 34.0580, lng: -118.2600, recordedAt: new Date(Date.now() - 15 * 60 * 1000) },
                { lat: 34.0620, lng: -118.2700, recordedAt: new Date(Date.now() - 20 * 60 * 1000) },
            ],
            'device2': [
                { lat: 37.7749, lng: -122.4194, recordedAt: new Date(Date.now() - 30 * 60 * 1000) }, // SF
                { lat: 37.7780, lng: -122.4250, recordedAt: new Date(Date.now() - 40 * 60 * 1000) },
            ],
            'device3': [
                { lat: 33.7490, lng: -84.3880, recordedAt: new Date(Date.now() - 2 * 60 * 60 * 1000) }, // Atlanta
                { lat: 33.7550, lng: -84.3950, recordedAt: new Date(Date.now() - 2.5 * 60 * 60 * 1000) },
                { lat: 33.7600, lng: -84.4000, recordedAt: new Date(Date.now() - 3 * 60 * 60 * 1000) },
            ]
        };

        // --- Global Variables ---
        let map;
        let markers = {}; // Store Google Maps markers by deviceId
        let polylines = {}; // Store Google Maps polylines by deviceId
        let activeDeviceId = null;
        const currentUser = MOCK_USERS[0]; // Simulate a logged-in user

        // --- DOM Elements ---
        const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
        const logoutButton = document.getElementById('logoutButton');
        const deviceListUl = document.getElementById('deviceList');
        const sidebarLoading = document.getElementById('sidebarLoading');
        const mapLoading = document.getElementById('mapLoading');

        // --- Helper Functions ---

        function showLoading(element) { element.style.display = 'flex'; }
        function hideLoading(element) { element.style.display = 'none'; }

        function formatRelativeTime(date) {
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `${seconds} secs ago`;
            if (minutes < 60) return `${minutes} mins ago`;
            if (hours < 24) return `${hours} hours ago`;
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString(); // Fallback for older dates
        }

        function createLocationIcon(color) {
            return {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: color,
                fillOpacity: 0.9,
                strokeColor: 'white',
                strokeWeight: 2,
                scale: 8,
            };
        }

        // --- Google Maps Initialization ---
        function initMap() {
            hideLoading(mapLoading); // Hide initial map loading spinner once API is ready
            console.log("Google Maps API loaded.");
            const defaultLocation = { lat: 34.0522, lng: -118.2437 }; // Default to Los Angeles

            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 10,
                mapId: 'YOUR_MAP_ID', // Optional: Use a custom map style from Google Cloud Console
                // Dark mode map style - you can generate more complex styles at snazzymaps.com or Google Cloud Console
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#263c3f" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#6b9a76" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#746855" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#1f2835" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#f3d19c" }],
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#2f3948" }],
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#515c6d" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#17263c" }],
                    },
                ]
            });

            // Initial dashboard setup after map is ready
            setupDashboard();
        }

        // --- API Simulation Functions ---

        async function fetchDevices(userId) {
            showLoading(sidebarLoading);
            console.log(`[MOCK API] Fetching devices for user: ${userId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    hideLoading(sidebarLoading);
                    const userDevices = MOCK_DEVICES.filter(d => d.userId === userId);
                    resolve(userDevices);
                }, 800); // Simulate network delay
            });
        }

        async function fetchLocationHistory(deviceId) {
            showLoading(mapLoading);
            console.log(`[MOCK API] Fetching location history for device: ${deviceId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    hideLoading(mapLoading);
                    const locations = MOCK_LOCATION_SAMPLES[deviceId] || [];
                    resolve(locations.sort((a, b) => a.recordedAt - b.recordedAt)); // Sort chronologically
                }, 1200); // Simulate network delay
            });
        }

        async function toggleDeviceSharing(deviceId, enable) {
            console.log(`[MOCK API] Toggling sharing for device ${deviceId} to ${enable}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    const device = MOCK_DEVICES.find(d => d.id === deviceId);
                    if (device) {
                        device.sharingEnabled = enable;
                        device.lastUpdated = new Date(); // Simulate update
                        resolve({ success: true, newStatus: enable });
                    } else {
                        resolve({ success: false, message: 'Device not found' });
                    }
                }, 500);
            });
        }

        async function revokeDevice(deviceId) {
            console.log(`[MOCK API] Revoking device: ${deviceId}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    MOCK_DEVICES = MOCK_DEVICES.filter(d => d.id !== deviceId);
                    delete MOCK_LOCATION_SAMPLES[deviceId]; // Also remove its locations
                    resolve({ success: true });
                }, 700);
            });
        }

        // --- Dashboard Rendering & Logic ---

        function renderDeviceList(devices) {
            deviceListUl.innerHTML = ''; // Clear existing list
            if (!devices || devices.length === 0) {
                deviceListUl.innerHTML = `<li style="text-align: center; color: var(--text-color-secondary); padding: 20px;">No devices found.</li>`;
                return;
            }

            devices.forEach(device => {
                const li = document.createElement('li');
                li.dataset.deviceId = device.id;
                if (device.id === activeDeviceId) {
                    li.classList.add('active');
                }

                const sharingStatusClass = device.sharingEnabled ? 'enabled' : 'paused';
                const sharingStatusText = device.sharingEnabled ? 'Enabled' : 'Paused';

                li.innerHTML = `
                    <div class="device-status-badge ${sharingStatusClass}">${sharingStatusText}</div>
                    <div class="device-name">${device.label}</div>
                    <div class="last-update">Last update: ${formatRelativeTime(new Date(device.lastUpdated))}</div>
                    <div class="device-controls">
                        <button class="toggle-sharing-btn ${device.sharingEnabled ? 'outline' : ''}" data-device-id="${device.id}" data-current-status="${device.sharingEnabled}">
                            ${device.sharingEnabled ? 'Pause Sharing' : 'Enable Sharing'}
                        </button>
                        <button class="revoke-device-btn danger outline" data-device-id="${device.id}">Revoke Device</button>
                    </div>
                `;
                deviceListUl.appendChild(li);
            });
        }

        function clearMap() {
            // Clear existing markers
            Object.values(markers).forEach(marker => marker.setMap(null));
            markers = {};
            // Clear existing polylines
            Object.values(polylines).forEach(polyline => polyline.setMap(null));
            polylines = {};
        }

        function plotDeviceLocations(deviceId, locations) {
            clearMap();

            if (!map || !locations || locations.length === 0) {
                console.warn(`No map or locations to plot for device ${deviceId}.`);
                return;
            }

            const path = [];
            let bounds = new google.maps.LatLngBounds();

            locations.forEach((loc, index) => {
                const position = { lat: loc.lat, lng: loc.lng };
                path.push(position);
                bounds.extend(position);

                // Add marker for the latest location
                if (index === locations.length - 1) {
                    markers[deviceId] = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: `${MOCK_DEVICES.find(d => d.id === deviceId)?.label || 'Device'} (Last Known)`,
                        icon: createLocationIcon(MOCK_DEVICES.find(d => d.id === deviceId)?.sharingEnabled ? '#28a745' : '#ffc107'), // Green for enabled, orange for paused
                        animation: google.maps.Animation.DROP,
                    });
                }
            });

            // Draw polyline for historical path
            if (path.length > 1) {
                polylines[deviceId] = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: var_accent_color_blue, /* Use CSS variable for consistency */
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    map: map,
                });
            }

            // Fit map to show all locations
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            } else if (locations.length > 0) {
                map.setCenter(path[0]);
                map.setZoom(15);
            }
        }

        async function selectDevice(deviceId) {
            activeDeviceId = deviceId;

            // Update active state in sidebar
            document.querySelectorAll('.device-list li').forEach(item => {
                if (item.dataset.deviceId === deviceId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            const locations = await fetchLocationHistory(deviceId);
            plotDeviceLocations(deviceId, locations);
        }

        // --- Event Handlers ---

        async function handleDeviceListClick(event) {
            const listItem = event.target.closest('li[data-device-id]');
            if (!listItem) return;

            const deviceId = listItem.dataset.deviceId;

            if (event.target.classList.contains('toggle-sharing-btn')) {
                const currentStatus = event.target.dataset.currentStatus === 'true';
                const result = await toggleDeviceSharing(deviceId, !currentStatus);
                if (result.success) {
                    // Re-render device list to reflect new status
                    const updatedDevices = await fetchDevices(currentUser.id);
                    renderDeviceList(updatedDevices);
                    // If this was the active device, update its marker color
                    if (activeDeviceId === deviceId) {
                        plotDeviceLocations(deviceId, MOCK_LOCATION_SAMPLES[deviceId] || []);
                    }
                } else {
                    alert(`Failed to update sharing: ${result.message}`);
                }
            } else if (event.target.classList.contains('revoke-device-btn')) {
                if (confirm(`Are you sure you want to revoke access for "${listItem.querySelector('.device-name').textContent}"? This cannot be undone.`)) {
                    const result = await revokeDevice(deviceId);
                    if (result.success) {
                        alert('Device revoked successfully.');
                        // Re-fetch and re-render devices
                        const updatedDevices = await fetchDevices(currentUser.id);
                        renderDeviceList(updatedDevices);
                        if (activeDeviceId === deviceId) {
                            clearMap(); // Clear map if active device was revoked
                            activeDeviceId = null;
                        }
                    } else {
                        alert('Failed to revoke device.');
                    }
                }
            } else { // Clicked on the li itself (not a button)
                await selectDevice(deviceId);
            }
        }

        function handleLogout() {
            // In a real app:
            // 1. Call your backend logout API to invalidate tokens.
            // 2. Clear local storage (JWT, user info).
            // 3. Redirect to login page.
            alert('Logging out...');
            localStorage.removeItem('jwt'); // Example JWT clearing
            localStorage.removeItem('userEmail');
            // For this demo, we'll just reload to simulate a fresh start
            location.reload();
        }


        // --- Initial Dashboard Setup ---
        async function setupDashboard() {
            loggedInUserEmailSpan.textContent = currentUser.email;
            logoutButton.addEventListener('click', handleLogout);
            deviceListUl.addEventListener('click', handleDeviceListClick);

            const devices = await fetchDevices(currentUser.id);
            renderDeviceList(devices);

            // Automatically select the first device if available
            if (devices.length > 0) {
                await selectDevice(devices[0].id);
            } else {
                hideLoading(mapLoading); // No devices, no map data to load
            }
        }

        // --- Entry Point (After DOM is fully loaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Show loading overlay for map until initMap is called by Google Maps API
            showLoading(mapLoading);
            // setupDashboard will be called by initMap() once Google Maps is ready
        });
    </script>
</body>
</html>
